<!DOCTYPE html>
<html>
  <head>
    <title>Sign In & 3D Data Visualization</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
      body {
        margin: 0;
        font-family: Helvetica, sans-serif;
        background-color: #000;
        overflow: hidden;
      }

      /* LOGIN OVERLAY */
      #login-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: #ffffff;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        transition: opacity 0.8s ease-out;
      }

      .login-card {
        background: white;
        padding: 60px 40px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 400px;
        width: 80%;
        border: 1px solid #e0e0e0;
      }

      .login-card h2 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 24px;
        font-weight: normal;
      }

      .login-card p {
        color: #888;
        font-size: 12px;
        margin-bottom: 30px;
      }

      #google-btn-wrapper {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }

      /* 3D SCENE CONTAINER */
      #container {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
      }

      /* MENU BUTTONS */
      #menu {
        position: absolute;
        bottom: 20px;
        width: 100%;
        text-align: center;
        z-index: 100;
      }

      button {
        color: rgba(127, 255, 255, 0.75);
        background: transparent;
        outline: 1px solid rgba(127, 255, 255, 0.75);
        border: 0;
        padding: 5px 10px;
        cursor: pointer;
        margin: 0 5px;
        text-transform: uppercase;
      }

      button:hover {
        background-color: rgba(0, 255, 255, 0.5);
      }

      button:active {
        color: #000;
        background-color: rgba(0, 255, 255, 0.75);
      }

      /* 3D CARD ELEMENT */
      .element {
        width: 120px;
        height: 160px;
        box-shadow: 0px 0px 12px rgba(0, 255, 255, 0.5);
        border: 1px solid rgba(127, 255, 255, 0.25);
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        transition: transform 0.3s;
        cursor: default;
      }

      .element:hover {
        transform: scale(1.1);
        z-index: 10;
        box-shadow: 0 0 12px rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(255, 255, 255, 0.75);
      }

      .element img {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid rgba(255, 255, 255, 0.8);
        margin-bottom: 10px;
      }

      .element .name {
        font-weight: bold;
        font-size: 14px;
        text-transform: uppercase;
        margin-bottom: 5px;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
      }

      .element .details {
        font-size: 11px;
        background: rgba(0, 0, 0, 0.3);
        padding: 2px 6px;
        border-radius: 4px;
        color: rgba(255, 255, 255, 0.9);
      }
    </style>
  </head>

  <body>
    <!-- LOGIN OVERLAY -->
    <div id="login-overlay">
      <div class="login-card">
        <h2>Welcome Back</h2>
        <p>Sign in with Google to continue</p>
        <div id="google-btn-wrapper"></div>
      </div>
    </div>

    <!-- 3D APP -->
    <div id="container"></div>
    <div id="menu">
      <button id="table">TABLE</button>
      <button id="sphere">SPHERE</button>
      <button id="helix">HELIX</button>
      <button id="grid">GRID</button>
    </div>

    <!-- Import Map for Three.js -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
      }
    </script>

    <script type="module">
      import * as THREE from "three";
      import TWEEN from "three/addons/libs/tween.module.js";
      import { TrackballControls } from "three/addons/controls/TrackballControls.js";
      import {
        CSS3DRenderer,
        CSS3DObject,
      } from "three/addons/renderers/CSS3DRenderer.js";

      // ----------------------------
      // CONFIGURATION
      // ----------------------------
      const GOOGLE_CLIENT_ID =
        "471042040576-s0bd041uh64cpognlcsbu7ko0bfge5gp.apps.googleusercontent.com";
      // Optional: Load real Google Sheet CSV URL
      const GOOGLE_SHEET_CSV_URL =
        "https://docs.google.com/spreadsheets/d/1ANnOj4xZTW-hYUnw5q-UqlqYCK5XBkIPfLPC_V2vLhs/edit?usp=sharing";

      let tableData = [];
      let camera, scene, renderer, controls;
      const objects = [];
      const targets = { table: [], sphere: [], helix: [], grid: [] };

      // ----------------------------
      // GOOGLE SIGN-IN
      // ----------------------------
      window.onload = () => {
        google.accounts.id.initialize({
          client_id: GOOGLE_CLIENT_ID,
          callback: handleCredentialResponse,
        });

        google.accounts.id.renderButton(
          document.getElementById("google-btn-wrapper"),
          {
            theme: "outline",
            size: "large",
            width: 250,
          }
        );
      };

      function handleCredentialResponse(response) {
        console.log("Google Token:", response.credential);

        // Hide login overlay
        const overlay = document.getElementById("login-overlay");
        overlay.style.opacity = 0;
        setTimeout(() => (overlay.style.display = "none"), 800);

        // Start visualization
        initApp();
      }

      // ----------------------------
      // 3D DATA VISUALIZATION
      // ----------------------------
      async function initApp() {
        // Option A: Mock Data
        for (let i = 0; i < 200; i++) {
          const netWorth = Math.floor(Math.random() * 200000) + 50000;
          tableData.push({
            name: `User ${i + 1}`,
            image: `https://i.pravatar.cc/150?u=${i}`,
            net_worth: netWorth,
          });
        }

        // Option B: Fetch CSV from Google Sheet
        /*
        try {
          const response = await fetch(GOOGLE_SHEET_CSV_URL);
          const text = await response.text();
          const rows = text.split("\n").slice(1);
          tableData = rows.map(row => {
            const cols = row.split(",");
            if (cols.length < 4) return null;
            return {
              name: cols[0].trim(),
              details: cols[1].trim(),
              image: cols[2].trim(),
              net_worth: parseInt(cols[3].trim())
            };
          }).filter(item => item !== null);
        } catch (err) {
          console.error("CSV load failed, using mock data.", err);
        }
        */

        initScene();
        animate();
      }

      function initScene() {
        camera = new THREE.PerspectiveCamera(
          40,
          window.innerWidth / window.innerHeight,
          1,
          10000
        );
        camera.position.z = 3000;

        scene = new THREE.Scene();

        // Create elements
        tableData.forEach((item, i) => {
          const element = document.createElement("div");
          element.className = "element";

          // Conditional color
          if (item.net_worth < 100000)
            element.style.backgroundColor = "rgba(239,48,34,0.85)";
          else if (item.net_worth >= 200000)
            element.style.backgroundColor = "rgba(58,159,72,0.85)";
          else element.style.backgroundColor = "rgba(253,202,53,0.85)";

          element.innerHTML = `<img src="${item.image}"><div class="name">${
            item.name
          }</div><div class="details">$${item.net_worth.toLocaleString()}</div>`;

          const obj = new CSS3DObject(element);
          obj.position.set(
            Math.random() * 4000 - 2000,
            Math.random() * 4000 - 2000,
            Math.random() * 4000 - 2000
          );
          scene.add(obj);
          objects.push(obj);
        });

        setupLayouts();
        setupRenderer();
        setupControls();
        setupButtons();
        transform(targets.table, 2000);

        window.addEventListener("resize", onWindowResize);
      }

      function setupLayouts() {
        const vector = new THREE.Vector3();
        const l = objects.length;

        // TABLE
        objects.forEach((obj, i) => {
          const tableObj = new THREE.Object3D();
          tableObj.position.x = (i % 20) * 140 - 1330;
          tableObj.position.y = -Math.floor(i / 20) * 180 + 900;
          targets.table.push(tableObj);
        });

        // SPHERE
        for (let i = 0; i < l; i++) {
          const phi = Math.acos(-1 + (2 * i) / l);
          const theta = Math.sqrt(l * Math.PI) * phi;
          const sphereObj = new THREE.Object3D();
          sphereObj.position.setFromSphericalCoords(800, phi, theta);
          vector.copy(sphereObj.position).multiplyScalar(2);
          sphereObj.lookAt(vector);
          targets.sphere.push(sphereObj);
        }

        // HELIX
        for (let i = 0; i < l; i++) {
          const theta = i * 0.175 + (i % 2 ? Math.PI : 0);
          const y = -i * 8 + 450;
          const helixObj = new THREE.Object3D();
          helixObj.position.setFromCylindricalCoords(900, theta, y);
          vector.set(
            helixObj.position.x * 2,
            helixObj.position.y,
            helixObj.position.z * 2
          );
          helixObj.lookAt(vector);
          targets.helix.push(helixObj);
        }

        // GRID
        for (let i = 0; i < l; i++) {
          const ix = i % 10;
          const iy = Math.floor(i / 10) % 4;
          const iz = Math.floor(i / 40);
          const gridObj = new THREE.Object3D();
          gridObj.position.set(
            ix * 400 - 1800,
            -iy * 400 + 600,
            iz * 1000 - 2000
          );
          targets.grid.push(gridObj);
        }
      }

      function setupRenderer() {
        renderer = new CSS3DRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById("container").appendChild(renderer.domElement);
      }

      function setupControls() {
        controls = new TrackballControls(camera, renderer.domElement);
        controls.minDistance = 500;
        controls.maxDistance = 6000;
        controls.addEventListener("change", render);
      }

      function setupButtons() {
        document
          .getElementById("table")
          .addEventListener("click", () => transform(targets.table, 2000));
        document
          .getElementById("sphere")
          .addEventListener("click", () => transform(targets.sphere, 2000));
        document
          .getElementById("helix")
          .addEventListener("click", () => transform(targets.helix, 2000));
        document
          .getElementById("grid")
          .addEventListener("click", () => transform(targets.grid, 2000));
      }

      function transform(targets, duration) {
        TWEEN.removeAll();
        objects.forEach((obj, i) => {
          const target = targets[i];
          if (!target) return;
          new TWEEN.Tween(obj.position)
            .to(target.position, Math.random() * duration + duration)
            .easing(TWEEN.Easing.Exponential.InOut)
            .start();
          new TWEEN.Tween(obj.rotation)
            .to(target.rotation, Math.random() * duration + duration)
            .easing(TWEEN.Easing.Exponential.InOut)
            .start();
        });
        new TWEEN.Tween(this)
          .to({}, duration * 2)
          .onUpdate(render)
          .start();
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        render();
      }

      function animate() {
        requestAnimationFrame(animate);
        TWEEN.update();
        controls.update();
      }

      function render() {
        renderer.render(scene, camera);
      }
    </script>
  </body>
</html>
